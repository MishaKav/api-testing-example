name: Test Pytest Coverage Comment

on:
  workflow_dispatch:
    inputs:
      issue-number:
        description: 'PR number to comment on (use PR #13 for testing)'
        required: false
        default: '13'

permissions:
  contents: write
  checks: write
  pull-requests: write

jobs:
  test-pytest-coverage-comment:
    name: Test ${{ matrix.test-name }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          # Core coverage file type tests
          - test-name: 'XML Coverage'
            pytest-xml-coverage-path: './data/coverage_1.xml'
            pytest-coverage-path: ''
            junitxml-path: './data/pytest_1.xml'

          - test-name: 'TXT Coverage'
            pytest-xml-coverage-path: ''
            pytest-coverage-path: './data/pytest-coverage_4.txt'
            junitxml-path: './data/pytest_1.xml'

          - test-name: 'Both XML and TXT'
            pytest-xml-coverage-path: './data/coverage_1.xml'
            pytest-coverage-path: './data/pytest-coverage_1.txt'
            junitxml-path: './data/pytest_1.xml'

          - test-name: 'Large Test Suite (493K)'
            pytest-xml-coverage-path: './data/coverage_2.xml'
            pytest-coverage-path: ''
            junitxml-path: './data/pytest_3.xml'

          - test-name: 'TXT 100% Coverage'
            pytest-xml-coverage-path: ''
            pytest-coverage-path: './data/pytest-coverage_12.txt'
            junitxml-path: './data/pytest_1.xml'

          # Feature tests
          - test-name: 'Badge Options'
            pytest-xml-coverage-path: './data/coverage_1.xml'
            pytest-coverage-path: ''
            junitxml-path: './data/pytest_1.xml'
            hide-badge: 'true'
            text-instead-badge: 'true'

          - test-name: 'Hide Report'
            pytest-xml-coverage-path: ''
            pytest-coverage-path: './data/pytest-coverage_2.txt'
            junitxml-path: './data/pytest_1.xml'
            hide-report: 'true'

          - test-name: 'Create New Comment'
            pytest-xml-coverage-path: './data/coverage_2.xml'
            pytest-coverage-path: './data/pytest-coverage_2.txt'
            junitxml-path: './data/pytest_2.xml'
            create-new-comment: 'true'

          - test-name: 'Hide Comment (Outputs Only)'
            pytest-xml-coverage-path: ''
            pytest-coverage-path: './data/pytest-coverage_4.txt'
            junitxml-path: './data/pytest_1.xml'
            hide-comment: 'true'

          - test-name: 'All Visual + Link Options'
            pytest-xml-coverage-path: ''
            pytest-coverage-path: './data/pytest-coverage_12.txt'
            junitxml-path: './data/pytest_1.xml'
            text-instead-badge: 'true'
            remove-link-from-badge: 'true'
            remove-links-to-files: 'true'
            remove-links-to-lines: 'true'

    steps:
      - name: Checkout api-testing-example repo
        uses: actions/checkout@v5

      - name: Display test configuration
        run: |
          echo "Testing: ${{ matrix.test-name }}"
          echo "PR Number: ${{ inputs.issue-number }}"

      - name: Run pytest-coverage-comment
        id: coverageComment
        uses: MishaKav/pytest-coverage-comment@v1
        with:
          pytest-xml-coverage-path: ${{ matrix.pytest-xml-coverage-path }}
          pytest-coverage-path: ${{ matrix.pytest-coverage-path }}
          junitxml-path: ${{ matrix.junitxml-path }}
          issue-number: ${{ inputs.issue-number }}
          hide-badge: ${{ matrix.hide-badge || 'false' }}
          hide-report: ${{ matrix.hide-report || 'false' }}
          hide-comment: ${{ matrix.hide-comment || 'false' }}
          create-new-comment: ${{ matrix.create-new-comment || 'false' }}
          remove-link-from-badge: ${{ matrix.remove-link-from-badge || 'false' }}
          remove-links-to-files: ${{ matrix.remove-links-to-files || 'false' }}
          remove-links-to-lines: ${{ matrix.remove-links-to-lines || 'false' }}
          text-instead-badge: ${{ matrix.text-instead-badge || 'false' }}
          unique-id-for-comment: ${{ matrix.test-name }}

      - name: Check outputs
        run: |
          echo "=== ${{ matrix.test-name }} Results ==="
          echo "Coverage Percentage: ${{ steps.coverageComment.outputs.coverage }}"
          echo "Coverage Color: ${{ steps.coverageComment.outputs.color }}"
          echo "Coverage Warnings: ${{ steps.coverageComment.outputs.warnings }}"
          echo ""
          echo "Test Statistics:"
          echo "  Tests: ${{ steps.coverageComment.outputs.tests }}"
          echo "  Errors: ${{ steps.coverageComment.outputs.errors }}"
          echo "  Failures: ${{ steps.coverageComment.outputs.failures }}"
          echo "  Skipped: ${{ steps.coverageComment.outputs.skipped }}"
          echo "  Time: ${{ steps.coverageComment.outputs.time }}"
          echo ""
          echo "Coverage HTML (first 20 lines):"
          echo "${{ steps.coverageComment.outputs.coverageHtml }}" | head -n 20
          echo ""
          echo "âœ… Test completed successfully!"
